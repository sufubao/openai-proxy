# Nginx 负载均衡配置
# 用于多个代理实例之间的负载分发

events {
    worker_connections 4096;
}

http {
    upstream openai_proxy_backend {
        # 负载均衡算法: least_conn (最少连接) 或 ip_hash (IP 哈希)
        least_conn;

        # 后端服务实例
        server openai-proxy:8000 max_fails=3 fail_timeout=30s;

        # 如果有多个实例，添加更多 server 行
        # server openai-proxy-2:8000 max_fails=3 fail_timeout=30s;
        # server openai-proxy-3:8000 max_fails=3 fail_timeout=30s;

        # 保持连接
        keepalive 32;
    }

    # 限制请求速率 (可选)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        listen 80;
        server_name _;

        # 日志
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # 客户端上传大小限制
        client_max_body_size 10M;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # 健康检查端点
        location /health {
            proxy_pass http://openai_proxy_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 指标端点
        location /metrics {
            proxy_pass http://openai_proxy_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # API 代理
        location / {
            # 限流
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://openai_proxy_backend;
            proxy_http_version 1.1;

            # 头部设置
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";

            # 流式响应支持
            proxy_buffering off;
            proxy_cache off;
        }

        # v1 端点 (OpenAI 兼容)
        location /v1/ {
            proxy_pass http://openai_proxy_backend;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";

            # 流式响应
            proxy_buffering off;
            proxy_cache off;
        }
    }
}
